@model CreateHopDongVm
@{
    Layout = null;
    var listHangHoa = ViewData["ListHangHoa"] as SelectList;
}
<div>
    <form asp-action="Create" asp-controller="HopDong" class="frmHD" data-name="ajaxFormHopDong">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        <div class="info-hd-header">
            <i class="fa fa-user"></i> Thông tin khách hàng
        </div>
        <div class="form-group row">
            <label class="control-label col-md-2">Khách hàng </label>
            <div class="col-md-10">
                <label><input type="radio" name="TypeCustomer" checked /> Khách hàng mới</label>
                <label><input type="radio" name="TypeCustomer" /> Khách hàng cũ</label>
            </div>
        </div>
        <div class="form-group row">
            <label asp-for="TenKhachHang" class="control-label col-md-2"></label>
            <div class="col-md-3">
                <input asp-for="TenKhachHang" class="form-control" />
                <span asp-validation-for="TenKhachHang" class="text-danger"></span>
            </div>
            <label asp-for="HD_MA" class="control-label col-md-2"></label>
            <div class="col-md-3">
                <input asp-for="HD_MA" class="form-control" />
                <span asp-validation-for="HD_MA" class="text-danger"></span>
            </div>
        </div>
        <div class="form-group row">
            <label asp-for="CMND" class="control-label col-md-2"></label>
            <div class="col-md-3">
                <input asp-for="CMND" class="form-control" />
            </div>
            <label asp-for="SDT" class="control-label col-md-2"></label>
            <div class="col-md-3">
                <input asp-for="SDT" class="form-control" />
            </div>
        </div>
        <div class="form-group row">
            <label asp-for="DiaChi" class="control-label col-md-2"></label>
            <div class="col-md-3">
                <textarea asp-for="DiaChi" class="form-control" rows="3"></textarea>
            </div>
        </div>

        <div class="info-hd-header">
            <i class="fas fa-money-bill-alt"></i> Thông tin khoản vay
        </div>
        <div class="form-group row">
            <label asp-for="HangHoaId" class="control-label col-md-2"></label>
            <div class="col-md-3">
                <select class="form-control" asp-for="HangHoaId" asp-items="@listHangHoa">
                </select>
            </div>
            <label asp-for="TenTaiSan" class="control-label col-md-2"></label>
            <div class="col-md-3">
                <input asp-for="TenTaiSan" class="form-control" />
                <span asp-validation-for="TenTaiSan" class="text-danger"></span>
            </div>
        </div>
        <div class="form-group row">

            <label asp-for="HD_TongTienVayBanDau" class="control-label col-md-2"></label>
            <div class="col-md-3">
                <div class="input-group">
                    <input type="text" class="form-control money-textbox" value="@Model.HD_TongTienVayBanDau">
                    <input type="hidden" asp-for="HD_TongTienVayBanDau" />
                    <div class="input-group-append">
                        <span class="input-group-text">VNĐ</span>
                    </div>
                </div>
                <span asp-validation-for="HD_TongTienVayBanDau" class="text-danger"></span>
            </div>

        </div>
        <div class="form-group row">
            <label asp-for="HD_HinhThucLai" class="control-label col-md-2"></label>
            <div class="col-md-3">
                <select class="form-control" asp-for="HD_HinhThucLai" asp-items="@Html.GetEnumSelectList<EHinhThucLai>()" onchange="getMoTaHinhThucLai()">
                </select>
                <span asp-validation-for="HD_HinhThucLai" class="text-danger"></span>
            </div>
            <div class="col-md-3">
                <label><input asp-for="HD_IsThuLaiTruoc" /> Thu lãi trước</label>
            </div>
        </div>
        <div class="form-group row">
            <label asp-for="HD_TongThoiGianVay" class="control-label col-md-2"></label>
            <div class="col-md-3">
                <div class="input-group">
                    <input asp-for="HD_TongThoiGianVay" class="form-control">
                    <input type="hidden" asp-for="HD_TongTienVayBanDau" />
                    <div class="input-group-append">
                        <span class="input-group-text thoiGianVay"></span>
                    </div>
                </div>
                <span asp-validation-for="HD_TongThoiGianVay" class="text-danger"></span>
            </div>
        </div>
        <div class="form-group row">
            <label asp-for="HD_KyLai" class="control-label col-md-2"></label>
            <div class="col-md-3">
                <div class="input-group">
                    <input asp-for="HD_KyLai" class="form-control">
                    <div class="input-group-append">
                        <span class="input-group-text thoiGianVay"></span>
                    </div>
                </div>
                <span asp-validation-for="HD_KyLai" class="text-danger"></span>
            </div>
            <div class="col-md-5 moTaKyLai">
            </div>
        </div>
        <div class="form-group row">
            <label asp-for="HD_LaiSuat" class="control-label col-md-2"></label>
            <div class="col-md-3">
                <div class="input-group">
                    <input asp-for="HD_LaiSuat" class="form-control">
                    <div class="input-group-append">
                        <span class="input-group-text tyLeLai"></span>
                    </div>
                </div>
                <span asp-validation-for="HD_LaiSuat" class="text-danger"></span>
            </div>
        </div>
        <div class="form-group row">
            <label asp-for="HD_NgayVay" class="control-label col-md-2"></label>
            <div class="col-md-3">
                <input asp-for="HD_NgayVay" class="form-control" />
            </div>
        </div>
        <div class="form-group row">
            <label asp-for="HD_GhiChu" class="control-label col-md-2"></label>
            <div class="col-md-3">
                <textarea asp-for="HD_GhiChu" rows="3" class="form-control"></textarea>
            </div>
        </div>
        <div class="info-hd-header" style="cursor:pointer" data-toggle="collapse" href="#collapseTaiSan" aria-expanded="true" aria-controls="collapseTaiSan">
            <i class="fa fa-motorcycle"></i> Thông tin tài sản <b>cấu hình tại đây</b>
        </div>
        <div class="collapse" id="collapseTaiSan">
        </div>
        <div class="form-group row">
            <label class="control-label col-md-2">&nbsp;</label>
            <div class="col-md-5">
                <button type="submit" class="btn btn-primary" data-modal="hd-modal">Lưu</button>
                <button type="button" data-dismiss="modal" aria-label="Close" class="btn btn-warning">Đóng</button>
            </div>
        </div>
    </form>

</div>

<script>
    setMoneyTextBox(".money-textbox");
    $(document).ready(function () {
        getMoTaHinhThucLai();
    })
    var lstThuocTinh = [];
    $('#HangHoaId').on("change", function () {
        var id = $(this).val();
        $.ajax({
            type: "GET",
            url: "/Admin/HopDong/GetListThuocTinhByTaiSan",
            data: { id: id },
            success: function (data) {
                if (data.length > 0) {
                    lstThuocTinh = data;
                    var html = "";
                    for (var i = 0; i < data.length; i++) {
                        html += '<div class="form-group row">' +
                            '<label class="control-label col-md-2">' + data[i].name + '</label>' +
                            '<div class="col-md-3">' +
                            '<input type="text" class="form-control" onchange="setValueThuocTinh(this)" data-idx="' + i + '" placeholder="Nhập ' + data[i].name + '"/>' +
                            '</div></div>';
                    };

                    $('#collapseTaiSan').html(html);
                }
            }
        })
    });
    function setValueThuocTinh(thiz) {
        var idx = $(thiz).attr("data-idx");
        var item = lstThuocTinh[idx];
        if (item) {
            item.value = $(thiz).val();
        }
    }

    function getMoTaHinhThucLai() {
        var type = $('#HD_HinhThucLai').val();
        console.log(type);
        $.ajax({
            type: "GET",
            url: "/Admin/MoTaHinhThucLai/GetMoTaHinhThucLai",
            data: { hinhThucLai: type },
            success: function (data) {
                if (data && data.length > 0) {
                    $('.tyLeLai').html(data[0].tyLeLai);
                    $('.motaKyLai').html(data[0].moTaKyLai);
                    $('.thoiGianVay').html(data[0].thoiGian);
                    $('.moTaKyLai').html(data[0].moTaKyLai);
                }
            }
        })
    }

    $("body").on("submit", 'form[data-name="ajaxFormHopDong"]', function (e) {
        e.preventDefault();
        var $form = $(this);
        var $btnSubmit = $form.find("button[type='submit']");
        var modal = $btnSubmit.data("modal");
        $btnSubmit.attr("disabled", "true");
        $.ajax({
            method: $form.attr("method"),
            url: $form.attr("action"),
            data: $form.serializeArray(),
            beforeSend: function () {
                $btnSubmit.append(`<i class="fas fa-sync-alt fa-fw fa-spin"></i>`);
            },
            complete: function () {
                $btnSubmit.find("i").remove();
            },
            success: function (res) {
                $btnSubmit.removeAttr("disabled");
                $form.find(".field-validation-valid").empty();
                if (res.isSuccessed == true) {
                    $(modal).modal("hide");
                    toastr.info(res.resultObj);
                } else if (res.validationErrors != null && res.validationErrors.length) {
                    $.each(res.validationErrors, function (i, v) {
                        console.log(v);
                        $form.find("span[data-valmsg-for='" + v.pos + "']").html(v.error);
                    });

                } else if (res.message != null) {
                    toastr.error(res.message);
                }
            }
        });
    });

</script>