@model HopDongVm
@{
    Layout = null;
    string lblDisplayDebitOrOverMoney = "";
    string lblDisplayLoanDebit = "";
    var tienthuaHD = Model.TongTienDaThanhToan - Model.TongTienGhiNo;
    var tabActive = ViewData["TabActive"] as string;
    if (string.IsNullOrEmpty(tabActive))
    {
        tabActive = "tab-dongtienlai";
    }
    var ListAuth = (List<string>)ViewBag.ListAuth;
}

<div class="row">
    <div class="col-md-6">
        <table class="table table-hover table-bordered table-detail-hd">
            <tbody>
                <tr id="trCusName">
                    <td colspan="3">
                        <span class="text-danger font-weight-bold" id="lblCusName">@Model.TenKhachHang</span>
                        <label id="lblCusPhone"> - <i class="fas fa-phone-alt" style="font-size:10px"></i><small> <i> @Model.SDT </i></small></label>
                        <span><i class="fas fas fa-map-marker-alt" style="font-size:10px"></i> @Model.DiaChi</span>
                    </td>
                </tr>
                  <tr>
                    <td><span class="font-weight-bold">Tiền đầu tư</span></td>
                  <td colspan="2" align="right"><span id="lblTotalMoney" class="lblTongTienVayHienTai">@Model.TongTienVayHienTai.ToString("N0")</span> VND</td>
                </tr>
                 <tr>
                    <td><span class="font-weight-bold">Lãi suất</span></td>
                    <td colspan="2" align="right"><span id="lblStrRate">@Model.TyLeLai</span></td>
                </tr>

                <tr>
                    <td><span class="font-weight-bold">Vay từ ngày</span></td>
                    <td align="right"><span id="lblFromDate">@Model.HD_NgayVay.ToString("dd/MM/yyyy")</span> </td>
                    <td align="right"><span id="lblToDate">@Model.HD_NgayDaoHan.ToString("dd/MM/yyyy")</span></td>
                </tr>

            </tbody>
        </table>
    </div>
    <div class="col-md-6">
        <table class="table table-hover table-bordered table-detail-hd">
            <tbody>
                <tr>
                    <td><span class="font-weight-bold">Tổng lãi</span></td>
                    <td colspan="2" align="right"><span id="lblStrRate">@Model.TongTienLaiDaThanhToan</span></td>
                </tr>
                <tr>
                    <td><span class="font-weight-bold">Đã thanh toán</span></td>
                    <td colspan="2" align="right">
                        <span id="lblPaymentMoney">@Model.TongTienLaiDaThanhToan.ToString("N0")</span> VNĐ
                    </td>
                </tr>
                <tr>
                    @if (tienthuaHD <= 0)
                    {
                        lblDisplayDebitOrOverMoney = "Nợ cũ KH";
                        lblDisplayLoanDebit = "Nợ cũ HĐ";
                    }
                    else
                    {
                        lblDisplayDebitOrOverMoney = "Tiền thừa KH";
                        lblDisplayLoanDebit = "Tiền thừa HĐ";
                    }
                    <td>
                        <span class="font-weight-bold" id="lblDisplayDebitOrOverMoney">@lblDisplayDebitOrOverMoney: </span>
                        <span class="@(tienthuaHD <= 0?"text-danger":"text-success") font-weight-bold" id="lblCustomerDebitMoney">
                            @if (tienthuaHD < 0)
                            {
                                tienthuaHD = tienthuaHD * -1;
                                <span>@(tienthuaHD.ToString("N0")) VNĐ</span>
                            }
                            else
                            {
                                <span>@(tienthuaHD.ToString("N0")) VNĐ</span>
                            }
                        </span>
                    </td>
                    <td align="right">
                        <span class="font-weight-bold" id="lblDisplayLoanDebit">@lblDisplayLoanDebit: </span>
                        <span class="@(tienthuaHD <= 0?"text-danger":"text-success") font-weight-bold" id="lblLoanDebitMoney">
                            @if (tienthuaHD < 0)
                            {
                                tienthuaHD = tienthuaHD * -1;
                                <span>@(tienthuaHD.ToString("N0")) VNĐ</span>
                            }
                            else
                            {
                                <span>@(tienthuaHD.ToString("N0")) VNĐ</span>
                            }
                        </span>
                    </td>
                </tr>
                <tr>
                    <td><span class="font-weight-bold">Trạng thái</span></td>
                    <td colspan="2" align="right" class="">
                        <span id="lblStatus">
                            <span class="m-badge m-badge--info m-badge--wide" style="font-size:12px">
                                @if (Model.HD_HinhThucLai == null)
                                {
                                    <span>Đang đầu tử</span>
                                }
                                else
                                {
                                     <span>Đang vay</span>
                                }
                        </span>
                    </span>
                </td>
            </tr>
        </tbody>
    </table>
</div>
</div>

<div class="tab-container">
    <div class="d-flex">
        @if (ListAuth.Contains("QuanLyNguonVon_TraTienLai"))
        {
            <div class="tabs tab-tratienlai" data-type="tab-tratienlai">
                <h6><i class="fas fa-money-bill"></i> Trả tiền lãi</h6>
            </div>
        }
        
        @if (ListAuth.Contains("QuanLyNguonVon_RutBotGoc"))
        {
            <div class="tabs tab-rutbotgoc" data-type="tab-rutbotgoc">
                <h6 class="font-weight-bold"><i class="fas fa-money-bill"></i> Rút bớt gốc</h6>
            </div>
        }
        @if (ListAuth.Contains("QuanLyNguonVon_VayThem"))
        {
            <div class="tabs" data-type="tab-vaythem">
                <h6><i class="fas fa-address-card"></i> Vay thêm</h6>
            </div>
        }
        @if (ListAuth.Contains("QuanLyNguonVon_GiaHan"))
        {
            <div class="tabs tab-giahan" data-type="tab-giahan">
                <h6><i class="fas fa-retweet"></i> Gia hạn</h6>
            </div>
        }
        @if (ListAuth.Contains("QuanLyNguonVon_RutVon"))
        {
            <div class="tabs tab-rutvon" data-type="tab-rutvon">
                <h6><i class="fas fa-retweet"></i> Rút vốn</h6>
            </div>
        }
        <div class="tabs tab-lichsu" data-type="tab-lichsu">
            <h6><i class="fas fa-retweet"></i> Lịch sử</h6>
        </div>


    </div>
    <div class="line"></div>
    <div class="mt-3">
        @if (ListAuth.Contains("QuanLyNguonVon_TraTienLai"))
        {
            <fieldset id="tab-tratienlai">
                <div id="divContent-Tralaitheongay">

                </div>
                <div id="divContent-ListPayment">

                </div>
            </fieldset>
        }
        @if (ListAuth.Contains("QuanLyNguonVon_RutBotGoc"))
        {
            <fieldset id="tab-rutbotgoc">
                <div class="d-flex justify-content-center">
                    <div class="col-md-6">
                        <form id="frmTraBotGoc" asp-action="TraBotGoc" asp-controller="HopDong_VayRutGoc" method="post">
                            <input type="hidden" name="HopDongId" id="HopDongId" value="@Model.Id" />
                            <div class="row mb-3">
                                <label class="col-4 text-end">Ngày rút tiền gốc</label>
                                <div class="col-8">
                                    <input type="date" value="@DateTime.Now.ToString("yyyy-MM-dd")" name="NgayTraGoc" class="form-control" />
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label class="col-4 text-end">Số tiền gốc cần rút</label>
                                <div class="col-8">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="SoTienTraGocDisplay" />
                                        <input type="hidden" name="SoTienTraGoc" />
                                        <span class="input-group-text">VNĐ</span>
                                    </div>
                                    <span class="text-danger field-validation-valid" data-valmsg-for="SoTienTraGoc" data-valmsg-replace="true"></span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label class="col-4 text-end">Ghi chú</label>
                                <div class="col-8">
                                    <textarea class="form-control" name="Note" rows="4"></textarea>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label class="col-4"></label>
                                <div class="col-8">
                                    <button class="btn btn-primary btn-sm" type="submit"><i class="fas fa-thumbs-up"></i> Đồng ý</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div id="divContent-ListTraGoc">

                </div>
            </fieldset>
        }
        @if (ListAuth.Contains("QuanLyNguonVon_VayThem"))
        {
            <fieldset id="tab-vaythem">
                <div class="d-flex justify-content-center">
                    <div class="col-md-6">
                        <form id="frmVayThem" asp-action="VayThem" asp-controller="HopDong_VayRutGoc" method="post">
                            <input type="hidden" name="HopDongId" id="HopDongId" value="@Model.Id" />
                            <div class="row mb-3">
                                <label class="col-4 text-end">Ngày vay thêm gốc</label>
                                <div class="col-8">
                                    <input type="date" value="@DateTime.Now.ToString("yyyy-MM-dd")" name="NgayVayThem" class="form-control" />
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label class="col-4 text-end">Số tiền gốc vay thêm</label>
                                <div class="col-8">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="SoTienVayThemDisplay" />
                                        <input type="hidden" name="SoTienVayThem" />
                                        <span class="input-group-text">VNĐ</span>
                                    </div>
                                    <span class="text-danger field-validation-valid" data-valmsg-for="SoTienVayThem" data-valmsg-replace="true"></span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label class="col-4 text-end">Ghi chú</label>
                                <div class="col-8">
                                    <textarea class="form-control" name="Note" rows="4"></textarea>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label class="col-4 text-end"></label>
                                <div class="col-8">
                                    <button class="btn btn-primary btn-sm" type="submit"><i class="fas fa-thumbs-up"></i> Đồng ý</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div id="divContent-ListVayThem">

                </div>
            </fieldset>
        }
        @if (ListAuth.Contains("QuanLyNguonVon_GiaHan"))
        {
            <fieldset id="tab-giahan">
                <div class="d-flex justify-content-center">
                    <div class="col-md-6">
                        <form id="frmGiaHan" asp-action="GiaHan" asp-controller="HopDong_GiaHan" method="post">
                            <input type="hidden" name="HopDongId" id="HopDongId" value="@Model.Id" />
                            <div class="row mb-3">
                                <label class="col-4 text-end">Khách Hàng</label>
                                <div class="col-8">
                                    <span>@Model.TenKhachHang</span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label class="col-4 text-end">Gia hạn thêm</label>
                                <div class="col-8">
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="SoNgayGiaHan" />
                                        <span class="input-group-text">@Model.ThoiGian.GetEnumDisplayName()</span>
                                    </div>
                                    <span class="text-danger field-validation-valid" data-valmsg-for="SoNgayGiaHan" data-valmsg-replace="true"></span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label class="col-4 text-end">Ghi chú</label>
                                <div class="col-8">
                                    <textarea class="form-control" name="Note" rows="4"></textarea>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label class="col-4"></label>
                                <div class="col-8">
                                    <button class="btn btn-primary btn-sm" type="submit"><i class="fas fa-thumbs-up"></i> Đồng ý</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div id="divContent-GiaHan">

                </div>
            </fieldset>
        }
        
        @if (ListAuth.Contains("QuanLyNguonVon_RutVon"))
        {
            <fieldset id="tab-rutvon">
                <div class="d-flex justify-content-center">
                    <div class="col-md-5">
                        <div id="divContent-chuocdo">

                        </div>
                    </div>
                </div>
            </fieldset>
        }
        <fieldset id="tab-lichsu">
            <div>
                <div class="d-flex justify-content-center">
                    <div class="col-md-6">
                        <form id="frmNhacNo" method="post" asp-action="Create" asp-controller="HopDong_DebtNote">
                            <input type="hidden" name="HopDongId" value="@Model.Id" />
                            <div class="row mb-3">
                                <label class="col-2 text-end">Ghi chú</label>
                                <div class="col-10">
                                    <textarea class="form-control" name="Note" rows="5"></textarea>
                                    <span class="text-danger field-validation-valid" data-valmsg-for="Note" data-valmsg-replace="true"></span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label class="col-2"></label>
                                <div class="col-10">
                                    <button class="btn btn-primary btn-sm" type="submit"><i class="fas fa-save"></i> Lưu lại</button>
                                </div>
                            </div>


                        </form>
                    </div>
                </div>
                <div id="divContent-CommentDebt">

                </div>
            </div>

            <div id="divContent-CuaHang_TransactionLog">

            </div>
        </fieldset>
    </div>
</div>

<script>
    $(document).ready(function () {
        setMoneyTextBox("#SoTienTraNoDisplay");
        setMoneyTextBox('#SoTienNoLaiDisplay');
       getListPaymentLog(@Model.Id);
        getInfoPaymentByDate(@Model.Id);
        var tab = '@tabActive';
        $('.' + tab).click();
    })


    function loadDataTab(type) {
        switch (type) {
            case "tab-lichsu":
                getCuahang_TransactionLog(@Model.Id,'@Model.HD_Loai');
                 geHopDong_DebtNote(@Model.Id);
                break;
            case "tab-tratienlai":
                getListPaymentLog(@Model.Id);
                getInfoPaymentByDate(@Model.Id);
                break;
            case "tab-rutbotgoc":
                getHistoryLoanExtra("tab-trabotgoc",@Model.Id);
                break;
            case "tab-vaythem":
                getHistoryLoanExtra(type,@Model.Id);
                break;
            case "tab-giahan":
                getListGiaHan(@Model.Id);
                break;
            case "tab-hengio":
                getListAlarmLog(@Model.Id);
                break;
             case "tab-chungtu":
                getChungTu(@Model.Id);
                break;
             case "tab-rutvon":
                getInfoChuocDo(@Model.Id,undefined,'@Model.HD_Loai');
                break;
            default:
                break;
            // code block
        }
    }

</script>